version: 0.2

phases:
  pre_build:
    commands:
      - chmod a+x ./utils/*
      - eval $(./utils/aws-cli-assumerole.sh -r $ASSUME_ROLE_NAME)
      - export TF_WARN_OUTPUT_ERRORS=true
  build:
    commands:
      - export PATH=$HOME:$PATH
      - echo Getting network stack outputs
      - cd ./terraformscripts/${ENVIRONMENT}-${ACCOUNT_ID}/network
      - terragrunt init --terragrunt-source-update
      - terragrunt validate
      - terragrunt output | grep ' = ' | tr -d "[:blank:]" | sed 's/^/TF_VAR_/' | tee ./terraform.output
      - export $(grep -v '^#' ./terraform.output | xargs)
      - echo Getting secrets
      - export TF_VAR_ssh_public="$(aws ssm get-parameter --with-decryption --name  /NHS/${ENVIRONMENT}-${ACCOUNT_ID}/tf/opentest/ec2_keypair | jq -r '.Parameter.Value')"
      - env | grep TF_VAR_
      - cd -
      - echo Provisioning Opentest
      - cd ./terraformscripts/${ENVIRONMENT}-${ACCOUNT_ID}/opentest
      - terragrunt init --terragrunt-source-update
      - terragrunt validate
      - terragrunt apply -auto-approve
