version: 0.2

phases:
  pre_build:
    commands:
      - chmod a+x ./utils/*
      - eval $(./utils/aws-cli-assumerole.sh -r $ASSUME_ROLE_NAME)
      - export TF_WARN_OUTPUT_ERRORS=true
  build:
    commands:
    - export VPC_ID=$(aws ec2 describe-vpcs --filters Name=tag:Name,Values=dev-${ENVIRONMENT} --query 'Vpcs[0].VpcId' --output text)
    - export PRIVATE_SUBNET=$(aws ec2 describe-subnets --filter Name=vpc-id,Values=${VPC_ID},Name=tag:Name,Values=${ENVIRONMENT}-private-subnet --query Subnets[].[SubnetId,AvailabilityZone] --output text | sort -k2 | head -n1 | cut -f1)
    - chmod +x ./terraformscripts/tf/modules/opentest/get-sg.sh
    - export SECURITY_GROUP=$(./terraformscripts/tf/modules/opentest/get-sg.sh)
    - echo Update project prm-servinginfra-lambdas-test with
    - echo - VpcId=${VPC_ID}
    - echo - Subnets=${PRIVATE_SUBNET}
    - echo - Security Group Ids=${SECURITY_GROUP}
    - aws codebuild update-project --name prm-servinginfra-lambdas-test --vpc-config vpcId=${VPC_ID},subnets=${PRIVATE_SUBNET},securityGroupIds=${SECURITY_GROUP}
